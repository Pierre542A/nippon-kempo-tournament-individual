import{Q as V}from"./QSpace-B1yT5Z3V.js";import{Y as W,Z as X,r as m,b as ee,J as ae,ak as le,w as se,_ as te,$ as r,an as b,a1 as o,a0 as t,ab as v,a2 as d,ah as D,ac as oe,ao as re,ae as ne,a4 as ie,ad as c,aa as f,K as P,a6 as N,ap as ue,ai as de,ag as k,a9 as E,al as S,aq as ce}from"./index-DRsz5w2d.js";import{Q as L}from"./QImg-Bpmswd2f.js";import{a as y}from"./QSelect-BQUXwyF1.js";import{Q as me}from"./QExpansionItem-COPq9p8b.js";import{Q as ve}from"./QForm-Cx9K0l2g.js";import{Q as pe}from"./QPage-D-rMEcpj.js";import{C as x}from"./ClosePopup-D3O_dCn1.js";import{u as fe}from"./use-quasar-BkUvSKY7.js";import{_ as ge}from"./_plugin-vue_export-helper-DlAUqK2U.js";import"./QSlideTransition-BEVZEWQ5.js";const we={class:"row justify-center"},be={class:"col-12 col-md-8"},ye={class:"row justify-center q-mb-xl"},he={class:"column items-center"},_e={class:"avatar-overlay"},Ve={class:"text-caption q-mt-sm text-grey-7"},Pe={class:"row q-col-gutter-md"},Se={class:"col-12 col-sm-6"},xe={class:"col-12 col-sm-6"},Ce={class:"col-12"},Qe={class:"col-12 col-sm-6"},qe={class:"col-12 col-sm-6"},Ue={class:"col-12 col-sm-6"},$e={class:"col-12 col-sm-6"},Ae={class:"col-12"},De={class:"col-12"},Ne={class:"col-12"},ke={class:"col-12"},Ee={class:"row q-col-gutter-md"},Le={class:"col-12"},je={class:"col-12 col-sm-6"},Me={class:"col-12 col-sm-6"},ze={class:"row q-col-gutter-md"},Fe={class:"col"},Re={class:"col"},Ie={class:"row justify-center q-mt-xl"},Be={class:"row q-col-gutter-md justify-center"},Oe="avataaars",Te=150,Ge=W({__name:"ProfileEditPage",setup(Ye){const n=fe(),h=le(),u=X(),i=m({grades:!1,clubs:!1,submit:!1,delete:!1}),j=/^[^\s@]+@[^\s@]+\.[^\s@]+$/,M=s=>j.test(s),z=/^[+]?[(]?[0-9]{1,4}[)]?[-\s.]?[0-9]{1,4}[-\s.]?[0-9]{1,9}$/,F=s=>z.test(s),C=s=>`https://api.dicebear.com/9.x/${Oe}/svg?seed=${s}&size=${Te}`,R=()=>Math.random().toString(36).slice(2,10),Q=m([]),q=m([]),I=[{id:1,name:"Homme"},{id:2,name:"Femme"}],l=m({firstName:"",lastName:"",email:"",birthDate:"",grade:null,club:null,currentPassword:"",gender:null,newPassword:"",confirmPassword:"",avatarSeed:"",weight:null,phone:"",nationality:""}),B=()=>!l.value.newPassword||l.value.newPassword===l.value.confirmPassword||"Les mots de passe ne correspondent pas",g=m(!1),w=m(!1),p=m("default"),O=ee(()=>C(p.value)),U=m([]),$=()=>{U.value=Array.from({length:20},R)},T=s=>{p.value=s,l.value.avatarSeed=s,n.notify({color:"positive",message:"Avatar sélectionné"}),g.value=!1},G=async()=>{i.value.grades=!0;try{const s=await b.get("undefined/grades");s.data?.success&&Array.isArray(s.data.grades)&&(q.value=s.data.grades)}catch(s){const e=s;n.notify({color:"negative",message:e.response?.data?.error||e.response?.data?.message||"Erreur lors du chargement des grades"})}finally{i.value.grades=!1}},Y=async()=>{i.value.clubs=!0;try{const s=await b.get("undefined/clubs");s.data?.success&&Array.isArray(s.data.clubs)&&(Q.value=s.data.clubs)}catch(s){const e=s;n.notify({color:"negative",message:e.response?.data?.error||e.response?.data?.message||"Erreur lors du chargement des clubs"})}finally{i.value.clubs=!1}},_=()=>{if(!u.user)return!1;const s=u.user;let e="";if(s.birth_date)try{const a=new Date(s.birth_date);if(!isNaN(a.getTime())){const A=a.getFullYear(),J=String(a.getMonth()+1).padStart(2,"0"),K=String(a.getDate()).padStart(2,"0");e=`${A}-${J}-${K}`}}catch{if(typeof s.birth_date=="string"){const a=s.birth_date.split("T");a.length>0&&a[0]&&(e=a[0])}}return l.value={firstName:s.first_name,lastName:s.last_name,email:s.email,birthDate:e,grade:s.id_grade,club:s.id_club,gender:s.id_gender,weight:s.weight||null,phone:s.phone||"",nationality:s.nationality,currentPassword:"",newPassword:"",confirmPassword:"",avatarSeed:s.avatar_seed||"default"},p.value=s.avatar_seed||"default",!0};ae(async()=>{if(await Promise.all([G(),Y()]),u.user)_();else try{await u.fetchSession(),_()}catch{n.notify({color:"negative",message:"Erreur lors du chargement de votre profil, veuillez vous reconnecter"}),h.push("/login")}$()}),se(()=>u.user,s=>{s&&_()},{deep:!0});const Z=async()=>{if(l.value.newPassword){if(!l.value.currentPassword){n.notify({color:"negative",message:"Le mot de passe actuel est requis pour changer le mot de passe"});return}if(l.value.newPassword.length<8){n.notify({color:"negative",message:"Le nouveau mot de passe doit contenir au moins 8 caractères"});return}if(l.value.newPassword!==l.value.confirmPassword){n.notify({color:"negative",message:"Les mots de passe ne correspondent pas"});return}}i.value.submit=!0;try{const s={first_name:l.value.firstName,last_name:l.value.lastName,email:l.value.email,birth_date:l.value.birthDate,avatar_seed:l.value.avatarSeed};l.value.nationality&&(s.nationality=l.value.nationality),l.value.gender!==null&&(s.id_gender=l.value.gender),l.value.phone&&(s.phone=l.value.phone),l.value.weight!==null&&(s.weight=l.value.weight),l.value.grade!==null&&(s.id_grade=l.value.grade),l.value.club!==null&&(s.id_club=l.value.club),l.value.newPassword&&l.value.currentPassword&&Object.assign(s,{password:l.value.newPassword,current_password:l.value.currentPassword}),await b.put(`undefined/users/${u.user.id}`,s),await u.fetchSession(),n.notify({color:"positive",message:"Profil mis à jour avec succès"}),h.push("/profile")}catch(s){const e=s;e.response?.status===409||e.response?.data?.error&&e.response.data.error.includes("email")||e.response?.data?.message&&e.response.data.message.includes("email")?n.notify({color:"negative",message:"Cet email est déjà utilisé par un autre compte"}):n.notify({color:"negative",message:e.response?.data?.error||e.response?.data?.message||"Erreur lors de la mise à jour du profil"})}finally{i.value.submit=!1}},H=async()=>{i.value.delete=!0;try{await b.put(`undefined/users/${u.user.id}`,{is_active:!1}),await u.logout(),n.notify({color:"info",message:"Votre compte a été supprimé. Vous avez été déconnecté."}),h.push("/")}catch(s){const e=s;n.notify({color:"negative",message:e.response?.data?.error||e.response?.data?.message||"Erreur lors de la suppression du compte"}),w.value=!1}finally{i.value.delete=!1}};return(s,e)=>(S(),te(pe,{class:"q-pa-lg"},{default:r(()=>[o("div",we,[o("div",be,[t(f,{flat:"",bordered:"",class:"profile-edit-card"},{default:r(()=>[t(v,{class:"row items-center bg-primary text-white"},{default:r(()=>[e[17]||(e[17]=o("div",{class:"text-h6"},"Modifier mon profil",-1)),t(V),t(d,{flat:"",icon:"arrow_back",label:"Retour",to:"/profile",color:"white"})]),_:1}),t(D),t(v,null,{default:r(()=>[t(ve,{onSubmit:oe(Z,["prevent"]),class:"q-gutter-md"},{default:r(()=>[o("div",ye,[o("div",he,[t(re,{size:"150px",class:"shadow-2 cursor-pointer",onClick:e[0]||(e[0]=a=>g.value=!0)},{default:r(()=>[t(L,{src:O.value},null,8,["src"]),o("div",_e,[t(ne,{name:"edit",size:"24px",color:"white"})])]),_:1}),o("div",Ve," Cliquez pour personnaliser votre avatar (Seed actuelle: "+ie(p.value)+") ",1)])]),o("div",Pe,[o("div",Se,[t(c,{modelValue:l.value.firstName,"onUpdate:modelValue":e[1]||(e[1]=a=>l.value.firstName=a),label:"Prénom",filled:"",rules:[a=>!!a||"Le prénom est requis"]},null,8,["modelValue","rules"])]),o("div",xe,[t(c,{modelValue:l.value.lastName,"onUpdate:modelValue":e[2]||(e[2]=a=>l.value.lastName=a),label:"Nom",filled:"",rules:[a=>!!a||"Le nom est requis"]},null,8,["modelValue","rules"])]),o("div",Ce,[t(c,{modelValue:l.value.email,"onUpdate:modelValue":e[3]||(e[3]=a=>l.value.email=a),type:"email",label:"Email",filled:"",rules:[a=>!!a||"L'email est requis",a=>M(a)||"Email invalide"]},null,8,["modelValue","rules"])]),o("div",Qe,[t(c,{modelValue:l.value.birthDate,"onUpdate:modelValue":e[4]||(e[4]=a=>l.value.birthDate=a),type:"date",label:"Date de naissance",filled:"",rules:[a=>!!a||"La date de naissance est requise"]},null,8,["modelValue","rules"])]),o("div",qe,[t(c,{modelValue:l.value.weight,"onUpdate:modelValue":e[5]||(e[5]=a=>l.value.weight=a),modelModifiers:{number:!0},type:"number",label:"Poids (kg)",filled:""},null,8,["modelValue"])]),o("div",Ue,[t(y,{modelValue:l.value.grade,"onUpdate:modelValue":e[6]||(e[6]=a=>l.value.grade=a),options:q.value,"option-value":"id","option-label":"name",label:"Grade",filled:"","emit-value":"","map-options":"",loading:i.value.grades},null,8,["modelValue","options","loading"])]),o("div",$e,[t(y,{modelValue:l.value.nationality,"onUpdate:modelValue":e[7]||(e[7]=a=>l.value.nationality=a),options:["Française","Autre"],label:"Nationalité",filled:""},null,8,["modelValue"])]),o("div",Ae,[t(y,{modelValue:l.value.club,"onUpdate:modelValue":e[8]||(e[8]=a=>l.value.club=a),options:Q.value,"option-value":"id","option-label":"name",label:"Club",filled:"","emit-value":"","map-options":"",loading:i.value.clubs},null,8,["modelValue","options","loading"])]),o("div",De,[t(c,{modelValue:l.value.phone,"onUpdate:modelValue":e[9]||(e[9]=a=>l.value.phone=a),label:"Téléphone",filled:"",rules:[a=>!a||F(a)||"Format de téléphone invalide"]},null,8,["modelValue","rules"])]),o("div",Ne,[t(y,{modelValue:l.value.gender,"onUpdate:modelValue":e[10]||(e[10]=a=>l.value.gender=a),options:I,"option-value":"id","option-label":"name",label:"Genre",filled:"","emit-value":"","map-options":""},null,8,["modelValue"])]),o("div",ke,[t(me,{icon:"lock",label:"Changer le mot de passe",caption:"Optionnel","header-class":"text-primary"},{default:r(()=>[t(f,null,{default:r(()=>[t(v,null,{default:r(()=>[o("div",Ee,[o("div",Le,[t(c,{modelValue:l.value.currentPassword,"onUpdate:modelValue":e[11]||(e[11]=a=>l.value.currentPassword=a),label:"Mot de passe actuel",type:"password",filled:""},null,8,["modelValue"])]),o("div",je,[t(c,{modelValue:l.value.newPassword,"onUpdate:modelValue":e[12]||(e[12]=a=>l.value.newPassword=a),label:"Nouveau mot de passe",type:"password",filled:"",rules:[a=>!a||a.length>=8||"Le mot de passe doit contenir au moins 8 caractères"]},null,8,["modelValue","rules"])]),o("div",Me,[t(c,{modelValue:l.value.confirmPassword,"onUpdate:modelValue":e[13]||(e[13]=a=>l.value.confirmPassword=a),label:"Confirmer",type:"password",filled:"",rules:[B]},null,8,["modelValue","rules"])])])]),_:1})]),_:1})]),_:1})])]),t(D,{class:"q-my-lg"}),o("div",ze,[o("div",Fe,[t(d,{label:"Annuler",type:"reset",flat:"",class:"full-width",color:"negative",to:"/profile"})]),o("div",Re,[t(d,{label:"Sauvegarder",type:"submit",color:"primary",class:"full-width",loading:i.value.submit},null,8,["loading"])])]),o("div",Ie,[t(d,{label:"Supprimer mon compte",color:"negative",flat:"",onClick:e[14]||(e[14]=a=>w.value=!0)})])]),_:1})]),_:1})]),_:1})])]),t(E,{modelValue:g.value,"onUpdate:modelValue":e[15]||(e[15]=a=>g.value=a)},{default:r(()=>[t(f,{style:{"min-width":"350px","max-width":"600px"}},{default:r(()=>[t(v,{class:"row items-center q-pb-none"},{default:r(()=>[e[18]||(e[18]=o("div",{class:"text-h6"},"Choisir votre avatar",-1)),t(V),P(t(d,{icon:"close",flat:"",round:"",dense:""},null,512),[[x]])]),_:1}),t(v,null,{default:r(()=>[e[19]||(e[19]=o("div",{class:"text-subtitle1 q-mb-sm"},"Avatars",-1)),o("div",Be,[(S(!0),N(de,null,ue(U.value,a=>(S(),N("div",{key:a,class:"custom-avatar-cell"},[t(f,{class:ce(["cursor-pointer avatar-card",{"avatar-selected":a===p.value}]),onClick:A=>T(a)},{default:r(()=>[t(L,{src:C(a)},null,8,["src"])]),_:2},1032,["class","onClick"])]))),128))])]),_:1}),t(k,{align:"center"},{default:r(()=>[t(d,{color:"primary",label:"Rafraîchir",onClick:$})]),_:1})]),_:1})]),_:1},8,["modelValue"]),t(E,{modelValue:w.value,"onUpdate:modelValue":e[16]||(e[16]=a=>w.value=a)},{default:r(()=>[t(f,{style:{"min-width":"300px"}},{default:r(()=>[t(v,{class:"row items-center bg-negative text-white"},{default:r(()=>[e[20]||(e[20]=o("div",{class:"text-h6"},"Confirmation",-1)),t(V),P(t(d,{icon:"close",flat:"",round:"",dense:""},null,512),[[x]])]),_:1}),t(v,null,{default:r(()=>e[21]||(e[21]=[o("p",{class:"text-body1"},"Êtes-vous sûr de vouloir supprimer votre compte ?",-1),o("p",{class:"text-body2"},"Cette action est irréversible.",-1)])),_:1}),t(k,{align:"right"},{default:r(()=>[P(t(d,{flat:"",label:"Annuler",color:"primary"},null,512),[[x]]),t(d,{flat:"",label:"Supprimer",color:"negative",onClick:H,loading:i.value.delete},null,8,["loading"])]),_:1})]),_:1})]),_:1},8,["modelValue"])]),_:1}))}}),oa=ge(Ge,[["__scopeId","data-v-07c423a2"]]);export{oa as default};

name: Tests Manuels AvancÃ©s

on:
  workflow_dispatch:
    inputs:
      test_scope:
        description: 'Type de test Ã  exÃ©cuter'
        required: true
        default: 'quick'
        type: choice
        options:
        - quick
        - api-deep
        - frontend-deep
        - full-integration
      target_environment:
        description: 'Environnement Ã  tester'
        required: true
        default: 'production'
        type: choice
        options:
        - production
        - simulate-local
      verbose_logs:
        description: 'Logs dÃ©taillÃ©s'
        required: false
        default: false
        type: boolean

jobs:
  # Job de configuration
  test-setup:
    name: "ğŸ”§ Test Configuration"
    runs-on: ubuntu-latest
    outputs:
      api_url: ${{ steps.config.outputs.api_url }}
      frontend_url: ${{ steps.config.outputs.frontend_url }}
      test_api: ${{ steps.config.outputs.test_api }}
      test_frontend: ${{ steps.config.outputs.test_frontend }}
      test_integration: ${{ steps.config.outputs.test_integration }}
    
    steps:
    - name: ğŸ”§ Configure test environment
      id: config
      run: |
        echo "ğŸ§ª Manual testing initiated..."
        echo "ğŸ‘¤ Triggered by: ${{ github.actor }}"
        echo "ğŸ• Time: $(date)"
        echo "ğŸ“‹ Scope: ${{ github.event.inputs.test_scope }}"
        echo "ğŸŒ Environment: ${{ github.event.inputs.target_environment }}"
        echo "ğŸ“ Verbose: ${{ github.event.inputs.verbose_logs }}"
        echo ""
        
        # Configuration URLs selon l'environnement
        if [ "${{ github.event.inputs.target_environment }}" = "production" ]; then
          echo "api_url=https://nippon-kempo-tournament-individualcube3.onrender.com" >> $GITHUB_OUTPUT
          echo "frontend_url=https://nippon-kempo-tournament-front.onrender.com" >> $GITHUB_OUTPUT
          echo "ğŸŒ Testing PRODUCTION environment"
        else
          echo "api_url=http://localhost:3000" >> $GITHUB_OUTPUT
          echo "frontend_url=http://localhost:8080" >> $GITHUB_OUTPUT
          echo "ğŸ–¥ï¸ Simulating LOCAL environment"
        fi
        
        # Configuration des tests selon le scope
        case "${{ github.event.inputs.test_scope }}" in
          "quick")
            echo "test_api=basic" >> $GITHUB_OUTPUT
            echo "test_frontend=basic" >> $GITHUB_OUTPUT
            echo "test_integration=false" >> $GITHUB_OUTPUT
            echo "âš¡ Quick tests configured"
            ;;
          "api-deep")
            echo "test_api=deep" >> $GITHUB_OUTPUT
            echo "test_frontend=false" >> $GITHUB_OUTPUT
            echo "test_integration=false" >> $GITHUB_OUTPUT
            echo "ğŸ” Deep API tests configured"
            ;;
          "frontend-deep")
            echo "test_api=false" >> $GITHUB_OUTPUT
            echo "test_frontend=deep" >> $GITHUB_OUTPUT
            echo "test_integration=false" >> $GITHUB_OUTPUT
            echo "ğŸ–¥ï¸ Deep Frontend tests configured"
            ;;
          "full-integration")
            echo "test_api=deep" >> $GITHUB_OUTPUT
            echo "test_frontend=deep" >> $GITHUB_OUTPUT
            echo "test_integration=true" >> $GITHUB_OUTPUT
            echo "ğŸ”— Full integration tests configured"
            ;;
        esac

  # Tests API conditionnels
  api-tests:
    name: "ğŸ§ª API Testing"
    runs-on: ubuntu-latest
    needs: test-setup
    if: needs.test-setup.outputs.test_api != 'false'
    
    steps:
    - name: ğŸ§ª Basic API tests
      if: needs.test-setup.outputs.test_api == 'basic'
      run: |
        echo "âš¡ Running basic API tests..."
        API_URL="${{ needs.test-setup.outputs.api_url }}"
        
        echo "1. ğŸ” Health check..."
        if curl -f -s "$API_URL/health" >/dev/null; then
          echo "âœ… API health check passed"
        else
          echo "âŒ API health check failed"
        fi
        
        echo "2. ğŸ† Tournaments endpoint..."
        if curl -f -s "$API_URL/api/tournaments" >/dev/null; then
          echo "âœ… Tournaments endpoint accessible"
        else
          echo "âŒ Tournaments endpoint failed"
        fi
        
        echo "âœ… Basic API tests completed"
    
    - name: ğŸ” Deep API tests
      if: needs.test-setup.outputs.test_api == 'deep'
      run: |
        echo "ğŸ” Running deep API tests..."
        API_URL="${{ needs.test-setup.outputs.api_url }}"
        
        echo "1. ğŸ” Health check with details..."
        HEALTH_RESPONSE=$(curl -s "$API_URL/health" 2>/dev/null)
        if [ $? -eq 0 ]; then
          echo "âœ… API health check passed"
          if [ "${{ github.event.inputs.verbose_logs }}" = "true" ]; then
            echo "Response: $HEALTH_RESPONSE"
          fi
        else
          echo "âŒ API health check failed"
        fi
        
        echo "2. ğŸ† Tournaments with data validation..."
        TOURNAMENTS_RESPONSE=$(curl -s "$API_URL/api/tournaments" 2>/dev/null)
        if [ $? -eq 0 ]; then
          echo "âœ… Tournaments endpoint accessible"
          
          # VÃ©rifier que c'est du JSON valide
          if echo "$TOURNAMENTS_RESPONSE" | jq . >/dev/null 2>&1; then
            echo "âœ… Valid JSON response"
            TOURNAMENT_COUNT=$(echo "$TOURNAMENTS_RESPONSE" | jq 'length' 2>/dev/null || echo "0")
            echo "ğŸ“Š Found $TOURNAMENT_COUNT tournaments"
          else
            echo "âš ï¸ Invalid JSON response"
          fi
        else
          echo "âŒ Tournaments endpoint failed"
        fi
        
        echo "3. ğŸ‘¤ User registration test..."
        TEST_EMAIL="manual-test-$(date +%s)@test.com"
        REGISTER_RESPONSE=$(curl -X POST "$API_URL/api/auth/register" \
          -H "Content-Type: application/json" \
          -d "{\"email\":\"$TEST_EMAIL\",\"password\":\"test123\",\"name\":\"Manual Test User\"}" \
          -s 2>/dev/null)
        
        if [ $? -eq 0 ]; then
          echo "âœ… Registration endpoint accessible"
          if echo "$REGISTER_RESPONSE" | grep -q "token\|success\|user"; then
            echo "âœ… Registration appears successful"
          else
            echo "âš ï¸ Registration response unexpected"
          fi
        else
          echo "âš ï¸ Registration endpoint test completed"
        fi
        
        echo "4. ğŸ” Authentication test..."
        LOGIN_RESPONSE=$(curl -X POST "$API_URL/api/auth/login" \
          -H "Content-Type: application/json" \
          -d "{\"email\":\"$TEST_EMAIL\",\"password\":\"test123\"}" \
          -s 2>/dev/null)
        
        if [ $? -eq 0 ] && echo "$LOGIN_RESPONSE" | grep -q "token"; then
          echo "âœ… Authentication appears to work"
          
          # Extraire le token pour test d'autorisation
          TOKEN=$(echo "$LOGIN_RESPONSE" | jq -r '.token' 2>/dev/null)
          if [ "$TOKEN" != "null" ] && [ -n "$TOKEN" ]; then
            echo "5. ğŸ›¡ï¸ Protected endpoint test..."
            PROFILE_RESPONSE=$(curl -H "Authorization: Bearer $TOKEN" \
              "$API_URL/api/user/profile" -s 2>/dev/null)
            
            if [ $? -eq 0 ]; then
              echo "âœ… Protected endpoint accessible with token"
            else
              echo "âš ï¸ Protected endpoint test completed"
            fi
          fi
        else
          echo "âš ï¸ Authentication test completed"
        fi
        
        echo "âœ… Deep API tests completed"

  # Tests Frontend conditionnels
  frontend-tests:
    name: "ğŸ–¥ï¸ Frontend Testing"
    runs-on: ubuntu-latest
    needs: test-setup
    if: needs.test-setup.outputs.test_frontend != 'false'
    
    steps:
    - name: ğŸ–¥ï¸ Basic Frontend tests
      if: needs.test-setup.outputs.test_frontend == 'basic'
      run: |
        echo "âš¡ Running basic Frontend tests..."
        FRONTEND_URL="${{ needs.test-setup.outputs.frontend_url }}"
        
        echo "1. ğŸ” Accessibility check..."
        if curl -f -s "$FRONTEND_URL" >/dev/null; then
          echo "âœ… Frontend is accessible"
        else
          echo "âŒ Frontend accessibility failed"
        fi
        
        echo "âœ… Basic Frontend tests completed"
    
    - name: ğŸ” Deep Frontend tests
      if: needs.test-setup.outputs.test_frontend == 'deep'
      run: |
        echo "ğŸ” Running deep Frontend tests..."
        FRONTEND_URL="${{ needs.test-setup.outputs.frontend_url }}"
        
        echo "1. ğŸ” Main page accessibility..."
        CONTENT=$(curl -s "$FRONTEND_URL" 2>/dev/null)
        if [ $? -eq 0 ]; then
          echo "âœ… Frontend main page accessible"
          
          echo "2. ğŸ¨ Content verification..."
          if echo "$CONTENT" | grep -qi "nippon.*kempo\|tournament\|kempo.*tournament"; then
            echo "âœ… Expected content found"
          else
            echo "âš ï¸ Expected content not found"
          fi
          
          echo "3. ğŸ“œ JavaScript assets check..."
          if echo "$CONTENT" | grep -q "script\|\.js"; then
            echo "âœ… JavaScript assets detected"
          else
            echo "âš ï¸ No JavaScript assets found"
          fi
          
          echo "4. ğŸ¨ CSS assets check..."
          if echo "$CONTENT" | grep -q "stylesheet\|\.css\|style"; then
            echo "âœ… CSS assets detected"
          else
            echo "âš ï¸ No CSS assets found"
          fi
          
          echo "5. âš¡ Vue.js/Quasar detection..."
          if echo "$CONTENT" | grep -qi "vue\|quasar"; then
            echo "âœ… Vue.js/Quasar framework detected"
          else
            echo "âš ï¸ Framework not explicitly detected"
          fi
          
          if [ "${{ github.event.inputs.verbose_logs }}" = "true" ]; then
            echo "ğŸ“ Page content sample (first 500 chars):"
            echo "$CONTENT" | head -c 500
            echo ""
          fi
          
        else
          echo "âŒ Frontend main page not accessible"
        fi
        
        echo "âœ… Deep Frontend tests completed"

  # Tests d'intÃ©gration
  integration-tests:
    name: "ğŸ”— Integration Testing"
    runs-on: ubuntu-latest
    needs: [test-setup, api-tests, frontend-tests]
    if: needs.test-setup.outputs.test_integration == 'true'
    
    steps:
    - name: ğŸ”— Full stack integration tests
      run: |
        echo "ğŸ”— Running full integration tests..."
        API_URL="${{ needs.test-setup.outputs.api_url }}"
        FRONTEND_URL="${{ needs.test-setup.outputs.frontend_url }}"
        
        echo "1. ğŸŒ Cross-origin communication test..."
        
        echo "2. ğŸ“Š Data flow test..."
        # Test que l'API retourne des donnÃ©es que le frontend peut utiliser
        API_DATA=$(curl -s "$API_URL/api/tournaments" 2>/dev/null)
        if echo "$API_DATA" | jq . >/dev/null 2>&1; then
          echo "âœ… API returns valid JSON data"
          
          # VÃ©rifier structure des donnÃ©es
          if echo "$API_DATA" | jq -e 'type == "array"' >/dev/null 2>&1; then
            echo "âœ… Tournaments data is properly formatted array"
          elif echo "$API_DATA" | jq -e 'has("tournaments")' >/dev/null 2>&1; then
            echo "âœ… Tournaments data has expected structure"
          else
            echo "âš ï¸ Tournaments data structure unknown but valid JSON"
          fi
        else
          echo "âš ï¸ API data format validation failed"
        fi
        
        echo "3. ğŸ”„ End-to-end availability test..."
        API_AVAILABLE=$(curl -s -o /dev/null -w "%{http_code}" "$API_URL/health" 2>/dev/null)
        FRONTEND_AVAILABLE=$(curl -s -o /dev/null -w "%{http_code}" "$FRONTEND_URL" 2>/dev/null)
        
        echo "ğŸ“Š Status codes:"
        echo "- API: $API_AVAILABLE"
        echo "- Frontend: $FRONTEND_AVAILABLE"
        
        if [ "$API_AVAILABLE" = "200" ] && [ "$FRONTEND_AVAILABLE" = "200" ]; then
          echo "âœ… Full stack is fully operational"
        else
          echo "âš ï¸ Some components may have issues"
        fi
        
        echo "âœ… Integration tests completed"

  # Rapport final
  test-report:
    name: "ğŸ“Š Test Report"
    runs-on: ubuntu-latest
    needs: [test-setup, api-tests, frontend-tests, integration-tests]
    if: always()
    
    steps:
    - name: ğŸ“Š Generate test report
      run: |
        echo "ğŸ“Š ===== MANUAL TEST REPORT ====="
        echo ""
        echo "ğŸ• Executed at: $(date)"
        echo "ğŸ‘¤ Triggered by: ${{ github.actor }}"
        echo "ğŸ“‹ Test scope: ${{ github.event.inputs.test_scope }}"
        echo "ğŸŒ Environment: ${{ github.event.inputs.target_environment }}"
        echo ""
        
        echo "ğŸ“Š Test Results:"
        echo "- Setup: ${{ needs.test-setup.result }}"
        echo "- API Tests: ${{ needs.api-tests.result }}"
        echo "- Frontend Tests: ${{ needs.frontend-tests.result }}"
        echo "- Integration Tests: ${{ needs.integration-tests.result }}"
        echo ""
        
        # URLs testÃ©es
        echo "ğŸŒ URLs tested:"
        echo "- Frontend: ${{ needs.test-setup.outputs.frontend_url }}"
        echo "- API: ${{ needs.test-setup.outputs.api_url }}"
        echo ""
        
        # Recommandations basÃ©es sur les rÃ©sultats
        if [ "${{ needs.api-tests.result }}" = "success" ] && [ "${{ needs.frontend-tests.result }}" = "success" ]; then
          echo "ğŸ‰ All tests passed successfully!"
          echo "âœ… Your application appears to be functioning correctly"
        else
          echo "âš ï¸ Some tests encountered issues"
          echo "ğŸ” Check the logs above for detailed information"
          echo "ğŸ’¡ Consider running individual test scopes for detailed debugging"
        fi
        
        echo ""
        echo "ğŸ“ Available test scopes for future runs:"
        echo "- quick: Fast health checks (5 min)"
        echo "- api-deep: Detailed API testing (10 min)"
        echo "- frontend-deep: Detailed Frontend testing (8 min)"
        echo "- full-integration: Complete system test (15 min)"
        echo ""
        echo "=============================="
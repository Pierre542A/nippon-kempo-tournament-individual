name: MANUAL.YML Pipeline - Tests Complets

on:
  workflow_dispatch:
    inputs:
      test_scope:
        description: 'Scope des tests'
        required: true
        default: 'quick'
        type: choice
        options:
        - quick
        - api-deep
        - frontend-deep
        - full-integration
      target_environment:
        description: 'Environnement cible'
        required: true
        default: 'production'
        type: choice
        options:
        - production
        - simulate-local

jobs:
  manual-tests:
    runs-on: ubuntu-latest
    
    steps:
    - name: Test configuration
      run: |
        echo "🧪 Starting manual tests..."
        echo "Scope: ${{ github.event.inputs.test_scope }}"
        echo "Environment: ${{ github.event.inputs.target_environment }}"
        echo "Triggered by: ${{ github.actor }}"
        echo "Time: $(date)"
    
    - name: Quick tests
      if: github.event.inputs.test_scope == 'quick'
      run: |
        echo "⚡ Running quick tests..."
        
        if [ "${{ github.event.inputs.target_environment }}" = "production" ]; then
          API_URL="https://nippon-kempo-tournament-individualcube3.onrender.com"
          FRONTEND_URL="https://nippon-kempo-tournament-front.onrender.com"
        else
          API_URL="http://localhost:3000"
          FRONTEND_URL="http://localhost:8080"
        fi
        
        echo "Testing API health: $API_URL"
        curl -f "$API_URL/health" && echo "✅ API OK" || echo "❌ API failed"
        
        echo "Testing Frontend: $FRONTEND_URL"
        curl -f "$FRONTEND_URL" && echo "✅ Frontend OK" || echo "❌ Frontend failed"
    
    - name: API deep tests
      if: github.event.inputs.test_scope == 'api-deep'
      run: |
        echo "🔍 Running deep API tests..."
        
        API_URL="https://nippon-kempo-tournament-individualcube3.onrender.com"
        
        echo "1. Health check..."
        curl -f "$API_URL/health" || echo "❌ Health failed"
        
        echo "2. Tournaments endpoint..."
        curl -f "$API_URL/api/tournaments" || echo "❌ Tournaments failed"
        
        echo "3. Authentication test..."
        curl -X POST "$API_URL/api/auth/register" \
          -H "Content-Type: application/json" \
          -d '{"email":"manual-test@test.com","password":"test123"}' \
          || echo "❌ Auth test completed"
        
        echo "✅ Deep API tests completed"
    
    - name: Frontend deep tests
      if: github.event.inputs.test_scope == 'frontend-deep'
      run: |
        echo "🖥️ Running deep Frontend tests..."
        
        FRONTEND_URL="https://nippon-kempo-tournament-front.onrender.com"
        
        echo "1. Main page..."
        curl -f "$FRONTEND_URL" || echo "❌ Main page failed"
        
        echo "2. Check for JS/CSS assets..."
        CONTENT=$(curl -s "$FRONTEND_URL")
        echo "$CONTENT" | grep -q "script" && echo "✅ JS assets found" || echo "⚠️ No JS assets"
        echo "$CONTENT" | grep -q "style\|css" && echo "✅ CSS assets found" || echo "⚠️ No CSS assets"
        
        echo "3. Check for Quasar/Vue..."
        echo "$CONTENT" | grep -qi "vue\|quasar" && echo "✅ Vue/Quasar detected" || echo "⚠️ Vue/Quasar not detected"
        
        echo "✅ Deep Frontend tests completed"
    
    - name: Full integration tests
      if: github.event.inputs.test_scope == 'full-integration'
      run: |
        echo "🔗 Running full integration tests..."
        
        API_URL="https://nippon-kempo-tournament-individualcube3.onrender.com"
        FRONTEND_URL="https://nippon-kempo-tournament-front.onrender.com"
        
        echo "1. API-Frontend communication test..."
        
        # Test que l'API retourne du JSON valide
        API_RESPONSE=$(curl -s "$API_URL/api/tournaments")
        echo "API Response sample: ${API_RESPONSE:0:100}..."
        
        if echo "$API_RESPONSE" | jq . >/dev/null 2>&1; then
          echo "✅ API returns valid JSON"
        else
          echo "⚠️ API response is not valid JSON"
        fi
        
        echo "2. Database connectivity test..."
        curl -f "$API_URL/health" && echo "✅ Database seems OK" || echo "❌ Database issues"
        
        echo "3. Full stack test..."
        echo "✅ Full integration tests completed"
    
    - name: Test summary
      run: |
        echo "📋 Manual test summary:"
        echo "- Scope: ${{ github.event.inputs.test_scope }}"
        echo "- Environment: ${{ github.event.inputs.target_environment }}"
        echo "- Status: Completed"
        echo "- Time: $(date)"
        echo ""
        echo "🌐 URLs tested:"
        echo "- API: https://nippon-kempo-tournament-individualcube3.onrender.com"
        echo "- Frontend: https://nippon-kempo-tournament-front.onrender.com"
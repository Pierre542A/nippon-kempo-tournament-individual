name: Deploy to Production

on:
  push:
    branches: [ main ]
  workflow_dispatch: # Permet de déclencher manuellement

jobs:
  # Job 1 : Vérifications avant déploiement
  pre-deploy-checks:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Verify main branch
      run: |
        echo "Deploying from branch: ${{ github.ref }}"
        echo "Commit SHA: ${{ github.sha }}"
    
    - name: Check if API changed
      id: api-changes
      run: |
        if git diff --name-only ${{ github.event.before }} ${{ github.sha }} | grep "^api/"; then
          echo "api_changed=true" >> $GITHUB_OUTPUT
        else
          echo "api_changed=false" >> $GITHUB_OUTPUT
        fi
    
    - name: Check if Frontend changed
      id: frontend-changes
      run: |
        if git diff --name-only ${{ github.event.before }} ${{ github.sha }} | grep "^front-quasar/"; then
          echo "frontend_changed=true" >> $GITHUB_OUTPUT
        else
          echo "frontend_changed=false" >> $GITHUB_OUTPUT
        fi
    
    outputs:
      api_changed: ${{ steps.api-changes.outputs.api_changed }}
      frontend_changed: ${{ steps.frontend-changes.outputs.frontend_changed }}

  # Job 2 : Déploiement (Render se déclenche automatiquement)
  deploy:
    runs-on: ubuntu-latest
    needs: pre-deploy-checks
    
    steps:
    - name: Deployment Info
      run: |
        echo "🚀 Déploiement en cours..."
        echo "API changed: ${{ needs.pre-deploy-checks.outputs.api_changed }}"
        echo "Frontend changed: ${{ needs.pre-deploy-checks.outputs.frontend_changed }}"
        echo "Render va automatiquement déployer depuis cette branche main"
    
    - name: Wait for Render deployment
      run: |
        echo "⏳ Attente du déploiement Render (60 secondes)..."
        sleep 60

  # Job 3 : Vérification post-déploiement
  post-deploy-checks:
    runs-on: ubuntu-latest
    needs: deploy
    
    steps:
    - name: Health check API
      run: |
        echo "🔍 Vérification de l'API..."
        # Remplacez par votre vraie URL Render API
        curl -f https://nippon-kempo-tournament-individualcube3.onrender.com/ || echo "⚠️ API health check échoué"
    
    - name: Health check Frontend
      run: |
        echo "🔍 Vérification du Frontend..."
        # Remplacez par votre vraie URL Render Frontend
        curl -f https://nippon-kempo-tournament-front.onrender.com/ || echo "⚠️ Frontend health check échoué"
    
    - name: Deployment success
      run: |
        echo "✅ Déploiement terminé !"
        echo "🌐 API: https://nippon-kempo-tournament-individualcube3.onrender.com"
        echo "🌐 Frontend: https://nippon-kempo-tournament-front.onrender.com"